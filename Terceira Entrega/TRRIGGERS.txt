-- FUNCTION DATA REGISTO 
CREATE OR REPLACE FUNCTION set_data_registo()
RETURNS TRIGGER AS $$
BEGIN
    NEW.DATA_REGISTO := date_trunc('second', CURRENT_TIMESTAMP);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;


-- TRIGGER DATA REGISTO
CREATE TRIGGER trigger_set_data_registo
BEFORE INSERT ON UTILIZADORES
FOR EACH ROW
EXECUTE FUNCTION set_data_registo();


-- FUNCTION VALIDAR EMAIL
CREATE OR REPLACE FUNCTION validar_email_unico()
RETURNS TRIGGER AS $$
BEGIN
    IF EXISTS (SELECT 1 FROM UTILIZADORES WHERE EMAIL = NEW.EMAIL) THEN
        RAISE EXCEPTION 'Email j√° existe!';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;


-- TRIGGER VALIDAR EMAIL
CREATE TRIGGER trigger_validar_email_unico
BEFORE INSERT ON UTILIZADORES
FOR EACH ROW
EXECUTE FUNCTION validar_email_unico();
